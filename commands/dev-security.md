---
description: 安全审查流程，planner 规划到安全检查到漏洞修复建议
---

# /dev-security - 安全审查流程

## 功能

启动安全审查流程，**严格的多阶段规划控制**：先规划审查范围，再执行安全检查，最后输出修复建议。

## 使用方式

```
/dev-security
/dev-security {审查范围}
```

## 完整流程

```
┌─────────────────────────────────────────────────────────────┐
│ Phase 1: 安全审查规划                                       │
│   planner 到规划安全审查范围和重点                          │
├─────────────────────────────────────────────────────────────┤
│ Phase 2: 执行安全检查                                       │
│   security-reviewer 到多维度安全检查                        │
├─────────────────────────────────────────────────────────────┤
│ Phase 3: 输出修复建议                                       │
│   生成安全报告和修复建议                                    │
└─────────────────────────────────────────────────────────────┘
```

## 启动提示

```
🔒 启动安全审查流程

将按以下流程执行：
1. Phase 1: 安全审查规划（识别范围、定义重点）
2. Phase 2: 执行安全检查（多维度检查）
3. Phase 3: 输出修复建议（安全报告）

⚠️  严格的多阶段规划控制：
   - Phase 1 强制使用 planner 规划审查策略
   - Phase 2 执行多维度安全检查
   - Phase 3 输出可执行的修复建议

请描述您要审查的范围：
```

---

## Phase 1: 安全审查规划

### 调用 Planner

```
📋 Phase 1: 安全审查规划

请调用 planner，规划本阶段的安全审查策略：

规划要求：
1. 分析审查范围（全项目/指定模块/指定文件）
2. 识别安全维度（注入/认证/授权/数据保护）
3. 定义审查重点（高敏感区域）
4. 规划审查步骤
5. 预估执行时间

输出格式参见 /dev 命令中的 "Planner 输出格式"
```

### 安全维度规划

```
## 安全审查策略

### 审查范围
- 审查类型: {全项目/指定模块/指定文件}
- 审查对象: {具体范围}

### 安全维度
- [ ] 注入攻击: SQL 注入、命令注入、LDAP 注入
- [ ] 认证授权: 身份验证、权限控制、会话管理
- [ ] 数据保护: 敏感数据加密、数据传输、存储安全
- [ ] 输入验证: 参数校验、边界检查、类型验证
- [ ] 输出编码: XSS 防护、CSRF 防护、HTML 编码
- [ ] 配置安全: 密钥管理、配置隔离、默认配置

### 高敏感区域
1. {区域1}
2. {区域2}
...
```

---

## Phase 2: 执行安全检查

### 安全检查维度

#### 1. 注入攻击检查
```
检查项：
- [ ] SQL 语句使用参数化查询
- [ ] 命令执行使用白名单验证
- [ ] ORM 查询安全
- [ ] 无字符串拼接构建查询
- [ ] 无动态代码执行
```

#### 2. 认证授权检查
```
检查项：
- [ ] 密码正确存储（哈希 + 盐）
- [ ] 会话管理安全
- [ ] 权限校验完整
- [ ] 敏感操作二次验证
- [ ] 登出正确处理
```

#### 3. 数据保护检查
```
检查项：
- [ ] 敏感数据加密存储
- [ ] 传输使用 HTTPS
- [ ] 日志脱敏处理
- [ ] 密钥不硬编码
- [ ] 临时数据及时清理
```

#### 4. 输入验证检查
```
检查项：
- [ ] 所有用户输入已验证
- [ ] 类型检查完整
- [ ] 长度限制合理
- [ ] 格式验证正确
- [ ] 边界条件处理
```

#### 5. 输出编码检查
```
检查项：
- [ ] HTML 输出正确编码
- [ ] JSON 输出安全
- [ ] URL 参数编码
- [ ] CSRF Token 使用
- [ ] Content-Type 正确
```

#### 6. 配置安全检查
```
检查项：
- [ ] 密钥使用环境变量
- [ ] 生产配置隔离
- [ ] 默认配置安全
- [ ] 调试模式关闭
- [ ] 错误信息不泄露
```

### 安全检查输出

```
## 安全检查报告

### 总体评分
- 注入攻击防护: {分数}/100
- 认证授权安全: {分数}/100
- 数据保护: {分数}/100
- 输入验证: {分数}/100
- 输出编码: {分数}/100
- 配置安全: {分数}/100

### 问题汇总
- CRITICAL: {数量} 个
- HIGH: {数量} 个
- MEDIUM: {数量} 个
- LOW: {数量} 个

### 详细问题

#### CRITICAL 级别
1. [{文件}:{行}] {安全问题}
   - 风险: {风险描述}
   - 影响: {潜在影响}
   - 修复建议: {具体方案}

#### HIGH 级别
...

#### MEDIUM 级别
...

#### LOW 级别
...
```

---

## Phase 3: 输出修复建议

### 安全报告

```
🔒 安全审查完成

## 总体评估
- 安全评分: {分数}/100
- 主要风险: {总结}
- 改进方向: {方向}

## 优先修复建议
1. [{CRITICAL}] {安全问题} - {修复建议}
2. [{HIGH}] {安全问题} - {修复建议}
3. [{MEDIUM}] {安全问题} - {修复建议}

## 安全最佳实践
- {实践1}
- {实践2}
...

## 下一步
- [ ] 立即修复 CRITICAL 级别问题
- [ ] 尽快修复 HIGH 级别问题
- [ ] 计划修复 MEDIUM 级别问题
- [ ] 安全审查通过后创建 PR
```

### 问题级别定义

| 级别 | 描述 | 示例 | 处理优先级 |
|------|------|------|-----------|
| **CRITICAL** | 严重安全漏洞，必须立即修复 | SQL 注入、密钥泄露、未授权访问 | 立即修复 |
| **HIGH** | 重要安全问题，应该尽快修复 | 弱密码算法、会话固定、XSS 漏洞 | 高优先级 |
| **MEDIUM** | 一般安全问题，建议修复 | 缺少日志、错误信息泄露、配置不当 | 中优先级 |
| **LOW** | 轻微安全问题，可选修复 | 注释不足、变量命名不规范 | 低优先级 |

### OWASP Top 10 检查

```
## OWASP Top 10 检查清单

- [ ] A01:2021 – 访问控制失效
- [ ] A02:2021 – 加密失败
- [ ] A03:2021 – 注入
- [ ] A04:2021 – 不安全设计
- [ ] A05:2021 – 错误的安全配置
- [ ] A06:2021 – 易受攻击和过时的组件
- [ ] A07:2021 – 身份识别和身份验证失败
- [ ] A08:2021 – 软件和数据完整性失败
- [ ] A09:2021 – 安全日志和监控失败
- [ ] A10:2021 – 服务器端请求伪造 (SSRF)
```

---

## 常见安全问题与修复

### SQL 注入
```javascript
// ❌ 错误：字符串拼接
const sql = `SELECT * FROM users WHERE id = '${userId}'`

// ✅ 正确：参数化查询
const sql = 'SELECT * FROM users WHERE id = ?'
db.query(sql, [userId])
```

### XSS 防护
```javascript
// ❌ 错误：直接渲染用户输入
div.innerHTML = userInput

// ✅ 正确：使用 textContent
div.textContent = userInput
// 或使用 DOMPurify 等库
div.textContent = DOMPurify.sanitize(userInput)
```

### 密钥管理
```javascript
// ❌ 错误：硬编码密钥
const apiKey = 'sk-proj-xxxxx'

// ✅ 正确：环境变量
const apiKey = process.env.API_KEY
if (!apiKey) throw new Error('API_KEY 未配置')
```

### 密码存储
```javascript
// ❌ 错误：明文存储
user.password = plainPassword

// ✅ 正确：哈希 + 盐
const hash = await bcrypt.hash(plainPassword, 10)
user.password = hash
```
