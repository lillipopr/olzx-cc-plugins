---
description: 测试相关流程，planner 规划 → 测试生成 → 覆盖率验证
---

# /dev-test - 测试相关流程

## 功能

启动测试相关流程，**严格的多阶段规划控制**：先规划测试策略，再生成测试，最后验证覆盖率。

## 使用方式

```
/dev-test
/dev-test generate    # 生成测试
/dev-test coverage    # 检查覆盖率
/dev-test e2e         # E2E 测试
```

## 完整流程

```
┌─────────────────────────────────────────────────────────────┐
│ Phase 1: 测试规划                                           │
│   planner → 规划测试策略和覆盖范围                          │
├─────────────────────────────────────────────────────────────┤
│ Phase 2: 测试生成                                           │
│   tdd-expert → 生成单元/集成/E2E 测试                       │
├─────────────────────────────────────────────────────────────┤
│ Phase 3: 覆盖率验证                                         │
│   验证测试覆盖率达到 80%+                                   │
└─────────────────────────────────────────────────────────────┘
```

## 启动提示

```
🧪 启动测试流程

请选择测试类型：

1. 生成测试        - 为代码生成完整的测试套件
2. 检查覆盖率      - 检查当前测试覆盖率
3. E2E 测试        - 生成和执行端到端测试
4. 补充测试        - 为现有代码补充缺失的测试

请输入数字或测试类型：
```

---

## Phase 1: 测试规划

### 调用 Planner

```
📋 Phase 1: 测试规划

请调用 planner，规划本阶段的测试策略：

规划要求：
1. 分析测试目标（功能/模块/全项目）
2. 识别测试类型（单元/集成/E2E）
3. 定义覆盖范围（正常/异常/边界）
4. 规划测试步骤
5. 预估执行时间

输出格式参见 /dev 命令中的 "Planner 输出格式"
```

### 测试策略规划

```
## 测试策略

### 测试目标
- 目标: {功能/模块/全项目}
- 测试类型: {单元/集成/E2E/全部}

### 覆盖范围
- 正常场景: {场景列表}
- 异常场景: {场景列表}
- 边界场景: {场景列表}

### 测试金字塔
- E2E 测试: {数量} ({百分比})
- 集成测试: {数量} ({百分比})
- 单元测试: {数量} ({百分比})

### 覆盖率目标
- 语句覆盖率: ≥80%
- 分支覆盖率: ≥75%
- 函数覆盖率: ≥90%
```

---

## Phase 2: 测试生成

### 执行 Agent

- **Agent**: `agents/tdd-expert/AGENT.md`
- **Skill**: `skills/for-tdd-expert/SKILL.md`

### 测试类型

#### 单元测试
```javascript
describe('Xxx', () => {
  describe('正常场景', () => {
    it('应该...', () => {})
  })

  describe('异常场景', () => {
    it('应该抛出错误当...', () => {})
  })

  describe('边界场景', () => {
    it('应该处理空值', () => {})
    it('应该处理最大值', () => {})
  })
})
```

#### 集成测试
```javascript
describe('Xxx Integration', () => {
  it('应该完成端到端业务流程', async () => {})
  it('应该正确处理跨模块交互', async () => {})
})
```

#### E2E 测试
```javascript
describe('Xxx E2E', () => {
  it('应该完成用户关键路径', async () => {
    // 页面操作
    // 数据验证
  })
})
```

---

## Phase 3: 覆盖率验证

### 验收标准

```
📋 测试覆盖率验收

### 覆盖率要求
- [ ] 语句覆盖率 ≥80%
- [ ] 分支覆盖率 ≥75%
- [ ] 函数覆盖率 ≥90%

### 当前覆盖率
- 语句覆盖率: {实际}%
- 分支覆盖率: {实际}%
- 函数覆盖率: {实际}%

### 未覆盖代码
- {文件}:{行} - {原因}

### 决策
- [ ] ✅ 通过，覆盖率达标
- [ ] ⚠️ 未达标，需要补充测试
```

### 覆盖率报告

```
## 测试覆盖率报告

### 总体覆盖率
- 语句覆盖率: {百分比}% ({目标} 80%)
- 分支覆盖率: {百分比}% ({目标} 75%)
- 函数覆盖率: {百分比}% ({目标} 90%)
- 行覆盖率: {百分比}%

### 各模块覆盖率
| 模块 | 语句 | 分支 | 函数 |
|------|------|------|------|
| {模块1} | {百分比}% | {百分比}% | {百分比}% |
| {模块2} | {百分比}% | {百分比}% | {百分比}% |

### 未覆盖代码
- {文件}:{行} - {未覆盖原因}

### 建议补充测试
1. {建议1}
2. {建议2}
...
```

---

## TDD 工作流

### RED-GREEN-REFACTOR

```
1. RED: 先写测试
   - 编写失败的测试用例
   - 运行测试，确认失败

2. GREEN: 实现功能
   - 编写最少代码使测试通过
   - 运行测试，确认通过

3. REFACTOR: 重构优化
   - 在测试保护下重构
   - 确保测试仍然通过
```

### 测试驱动清单

```
## TDD 检查清单

### RED 阶段
- [ ] 测试用例已编写
- [ ] 测试运行失败（预期失败）
- [ ] 失败原因是功能未实现

### GREEN 阶段
- [ ] 最小实现已完成
- [ ] 测试运行通过
- [ ] 没有过度实现

### REFACTOR 阶段
- [ ] 代码已重构
- [ ] 测试仍然通过
- [ ] 覆盖率未降低
```

---

## 完成总结

```
🧪 测试完成

## 测试摘要
- 测试类型: {类型}
- 测试用例数: {数量}
- 执行时间: {时间}

### 测试结果
- 通过: {数量} ✅
- 失败: {数量} ❌
- 跳过: {数量} ⏭️

### 覆盖率
- 语句覆盖率: {百分比}%
- 分支覆盖率: {百分比}%
- 函数覆盖率: {百分比}%

### 下一步
- [ ] 修复失败的测试
- [ ] 补充未覆盖的测试
- [ ] 提交代码
```
