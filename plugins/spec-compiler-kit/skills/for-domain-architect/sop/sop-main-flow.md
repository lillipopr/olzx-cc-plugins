# 领域架构师主流程 SOP

> **本文档定义了领域架构师的完整工作流程**，从 PRD 到《领域设计文档》的全流程。

## 工作流程概览

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    领域架构师完整工作流程                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  输入：PRD 文档                                                           │
│    ↓                                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ 第一部分：战略设计                                                │    │
│  │  1. 业务能力分析 → 识别核心业务能力                               │    │
│  │  2. 限界上下文划分 → 按业务能力拆分上下文                         │    │
│  │  3. 上下文映射 → 定义上下文间关系                                 │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│    ↓                                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ 第二部分：战术设计 - 统一建模                                      │    │
│  │  1. 聚合设计 → 识别聚合根、确定聚合边界                            │    │
│  │  2. 实体/值对象 → 区分实体与值对象                                │    │
│  │  3. 领域事件 → 定义领域事件                                       │    │
│  │  4. 领域服务 → 识别领域服务                                       │    │
│  │  5. 仓储接口 → 定义仓储接口                                       │    │
│  │  6. 应用层接口 → 行为列表（用户行为 + 系统行为）                   │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│    ↓                                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ 第三部分：约束定义                                                │    │
│  │  1. 状态定义表 → 定义每个实体的状态空间                           │    │
│  │  2. 状态转移表 → 定义合法的状态变化路径                           │    │
│  │  3. 不变量清单 → 定义系统必须满足的约束（伪代码）                  │    │
│  │  4. 禁止态说明 → 明确系统不允许进入的状态                         │    │
│  │  5. 约束执行时机表 → 定义约束何时执行                             │    │
│  │  6. 约束违反处理策略 → 定义违反约束时的处理方式                   │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│    ↓                                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ 第四部分：用例设计                                                │    │
│  │  1. 正向用例 → 覆盖所有 Happy Path                               │    │
│  │  2. Bad Case → 覆盖所有禁止态                                    │    │
│  │  3. 边界用例 → 覆盖边界条件                                      │    │
│  │  4. 用例覆盖矩阵 → 验证覆盖完整性                                │    │
│  │  5. 用例优先级 → 定义实现优先级                                   │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│    ↓                                                                     │
│  输出：《{功能名称} - 领域设计文档》                                      │
│    ↓                                                                     │
│  使用 Checklist 校验每一部分是否符合设计原则                               │
│    ↓                                                                     │
│  等待用户 Review → 如有问题则修改                                         │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## SOP-1：从 PRD 到领域设计文档

### 适用场景

- 新功能开发
- 从零开始设计领域模型

### 执行步骤

#### Step 1：读取并分析 PRD

1. 阅读 PRD 文档
2. 识别核心业务需求
3. 识别涉及的架构类型（后端/iOS/前端）
4. 识别相关上下文边界

#### Step 2：战略设计

详细步骤见 [sop-strategic-design.md](sop-strategic-design.md)

1. **业务能力分析**
   - 识别业务能力
   - 构建业务能力树
   - 定义能力分级（核心域/支撑域/通用域）

2. **限界上下文划分**
   - 按业务能力划分上下文
   - 定义上下文边界
   - 识别上下文类型

3. **上下文映射**
   - 定义上下文间关系
   - 选择集成模式（O/C, D, ACL, PL, CF）
   - 设计防腐层

#### Step 3：战术设计

详细步骤见 [sop-tactical-design.md](sop-tactical-design.md)

1. **聚合设计**
   - 识别聚合根
   - 确定聚合边界
   - 定义聚合间引用

2. **实体与值对象**
   - 使用三条件筛选实体（唯一ID、生命周期、状态转移）
   - 定义值对象
   - 区分实体与值对象

3. **领域事件**
   - 定义领域事件
   - 识别事件订阅方

4. **领域服务**
   - 识别领域服务（跨聚合协作）
   - 定义服务职责

5. **仓储接口**
   - 定义仓储接口
   - 定义查询方法

6. **应用层接口**
   - 定义用户行为（应用层意图）
   - 定义系统行为（领域层事实）

#### Step 4：约束定义

详细步骤见 [sop-constraints.md](sop-constraints.md)

1. **状态定义表**：定义每个实体的状态空间
2. **状态转移表**：定义合法的状态变化路径
3. **不变量清单**：定义系统约束（伪代码）
4. **禁止态说明**：明确禁止的状态转移
5. **约束执行时机表**：定义约束何时执行
6. **约束违反处理策略**：定义违反约束的处理方式

#### Step 5：用例设计

详细步骤见 [sop-use-cases.md](sop-use-cases.md)

1. **正向用例**：覆盖所有 Happy Path
2. **Bad Case**：覆盖所有禁止态
3. **边界用例**：覆盖边界条件
4. **用例覆盖矩阵**：验证覆盖完整性
5. **用例优先级**：定义实现优先级

#### Step 6：生成领域设计文档

使用 [domain-design-template.md](../templates/domain-design-template.md) 生成最终文档。

#### Step 7：Checklist 校验

使用各部分对应的检查清单验证设计质量：
- [战略设计检查清单](../checklists/strategic-checklist.md)
- [战术设计检查清单](../checklists/tactical-checklist.md)
- [约束检查清单](../checklists/constraint-checklist.md)
- [用例检查清单](../checklists/use-case-checklist.md)

#### Step 8：等待用户 Review

提醒用户 Review 以下内容：
- 战略设计是否合理
- 聚合边界是否正确
- 约束是否完整
- 用例覆盖是否充分

如有问题，使用 SOP-2 进行修改。

---

## SOP-2：Review 已有领域设计文档

### 适用场景

- Review 现有的领域设计文档
- 指出问题并给出建议
- 修改生成新版本

### 执行步骤

#### Step 1：读取已有领域设计文档

1. 读取文档内容
2. 识别文档结构
3. 检查文档完整性

#### Step 2：逐部分检查

使用检查清单逐项检查：

**第一部分：战略设计**
- [ ] 业务能力分析是否完整
- [ ] 限界上下文划分是否合理
- [ ] 上下文映射是否明确

**第二部分：战术设计**
- [ ] 聚合边界是否合理
- [ ] 实体与值对象是否正确区分
- [ ] 领域事件是否完整
- [ ] 领域服务是否恰当
- [ ] 仓储接口是否合理

**第三部分：约束定义**
- [ ] 状态定义是否完备且互斥
- [ ] 状态转移是否完整
- [ ] 不变量是否满足三测试
- [ ] 禁止态是否全部定义

**第四部分：用例设计**
- [ ] 正向用例是否覆盖核心路径
- [ ] Bad Case 是否覆盖禁止态
- [ ] 边界用例是否覆盖临界值
- [ ] 用例覆盖矩阵是否完整

#### Step 3：指出问题并给出建议

针对每个问题，给出：
1. 问题描述
2. 最佳实践参考
3. 修改建议

格式：
```
### 问题 {N}: {问题描述}

**当前情况**：{当前的设计}

**最佳实践**：{相关的 DDD 原则或设计模式}

**建议修改**：{具体的修改建议}

**参考**：{理论来源}
```

#### Step 4：等待用户确认

等待用户确认是否按建议修改。

#### Step 5：修改生成新版本

1. 按用户确认的修改意见进行修改
2. 生成新的领域设计文档
3. 使用 Checklist 验证修改后的文档

#### Step 6：再次等待用户 Review

提醒用户 Review 修改后的文档。

---

## 设计原则

### 理论依据

| 原则 | 来源 | 说明 |
|------|------|------|
| 聚合设计 | Eric Evans DDD | 实体收敛原则 |
| 不变量约束 | Bertrand Meyer | 面向对象软件构造 |
| 状态机建模 | David Harel | 状态图在软件设计中的应用 |
| 约束优先级 | Michael Jackson | 问题框架方法 |

### 跨端一致性原则

- **第一部分（战略设计）**：跨端唯一
- **第二部分（战术设计）**：跨端唯一（建模不绑定具体技术栈）
- **第三部分（约束定义）**：跨端一致（伪代码不绑定语言）
- **第四部分（用例设计）**：跨端一致（相同用例，各端验证）

### 设计质量标准

每个设计元素必须满足：

1. **有理论依据**：能说明为什么这样设计
2. **符合最佳实践**：与业内公认的设计模式一致
3. **可验证**：每个约束可写成 assert，每个用例可转化为测试
4. **可追溯**：设计决策可追溯到 PRD 需求

---

## 支持文档

### SOP 文档
- [战略设计 SOP](sop-strategic-design.md)
- [战术设计 SOP](sop-tactical-design.md)
- [约束定义 SOP](sop-constraints.md)
- [用例设计 SOP](sop-use-cases.md)

### 方法论文档
- [实体抽取方法论](../methodology/entity-extraction.md)
- [状态空间设计](../methodology/state-space-design.md)
- [不变量定义](../methodology/invariants.md)

### 原则文档
- [DDD 核心原则](../principles/ddd-principles.md)
- [聚合设计原则](../principles/aggregate-principles.md)
- [不变量原则](../principles/invariant-principles.md)

### 检查清单
- [战略设计检查清单](../checklists/strategic-checklist.md)
- [战术设计检查清单](../checklists/tactical-checklist.md)
- [约束检查清单](../checklists/constraint-checklist.md)
- [用例检查清单](../checklists/use-case-checklist.md)

### 模板
- [领域设计文档模板](../templates/domain-design-template.md)
