# 领域设计文档创建/迭代工作流 SOP

> **核心目标**：确保每个生成的领域设计文档达到 **90 分以上**才能交付。
> **评分机制**：每部分独立评分，加权计算总分，任一部分 < 60 分则直接不合格。

---

## 工作流程概览

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    领域设计文档创建/迭代完整工作流                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  输入：PRD 文档 / 用户需求                                                │
│    ↓                                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ 阶段 1：准备工作                                                │    │
│  │  1. 读取 PRD / 需求                                              │    │
│  │  2. 识别涉及的架构类型（后端/iOS/前端）                           │    │
│  │  3. 确定设计范围（新功能 / 迭代 / 重构）                          │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│    ↓                                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ 阶段 2：按部分逐个设计（每部分完成后自检）                          │    │
│  │  ┌─────────────────────────────────────────────────────────┐    │    │
│  │  │ 2.1 第一部分：战略设计                                    │    │    │
│  │  │     ↓ 设计完成                                            │    │    │
│  │  │     ↓ 使用 strategic-checklist.md 自检                    │    │    │
│  │  │     ↓ 计算 Part-1 分数（≥60 分通过）                      │    │    │
│  │  └─────────────────────────────────────────────────────────┘    │    │
│  │  ┌─────────────────────────────────────────────────────────┐    │    │
│  │  │ 2.2 第二部分：战术设计                                    │    │    │
│  │  │     ↓ 设计完成                                            │    │    │
│  │  │     ↓ 使用 tactical-checklist.md 自检                     │    │    │
│  │  │     ↓ 计算 Part-2 分数（≥60 分通过）                      │    │    │
│  │  └─────────────────────────────────────────────────────────┘    │    │
│  │  ┌─────────────────────────────────────────────────────────┐    │    │
│  │  │ 2.3 第三部分：约束定义                                    │    │    │
│  │  │     ↓ 设计完成                                            │    │    │
│  │  │     ↓ 使用 constraint-checklist.md 自检                   │    │    │
│  │  │     ↓ 计算 Part-3 分数（≥60 分通过）                      │    │    │
│  │  └─────────────────────────────────────────────────────────┘    │    │
│  │  ┌─────────────────────────────────────────────────────────┐    │    │
│  │  │ 2.4 第四部分：用例设计                                    │    │    │
│  │  │     ↓ 设计完成                                            │    │    │
│  │  │     ↓ 使用 usecase-checklist.md 自检                      │    │    │
│  │  │     ↓ 计算 Part-4 分数（≥60 分通过）                      │    │    │
│  │  └─────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│    ↓                                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ 阶段 3：综合评分                                                │    │
│  │  1. 计算加权总分：                                               │    │
│  │     Total = Part-1×20% + Part-2×30% + Part-3×25% + Part-4×25%  │    │
│  │  2. 检查：总分 ≥ 90 分？                                         │    │
│  │     YES → 进入阶段 4                                            │    │
│  │     NO  → 返回低分部分重新设计（迭代模式）                       │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│    ↓                                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ 阶段 4：交付前检查                                              │    │
│  │  1. 生成交付报告（包含评分详情）                                  │    │
│  │  2. 列出所有已知问题和建议                                       │    │
│  │  3. 等待用户 Review                                             │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│    ↓                                                                     │
│  输出：《{功能名称} - 领域设计文档》 + 评分报告                              │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 阶段 1：准备工作

### Step 1.1：读取并分析 PRD

1. 阅读 PRD 文档
2. 识别核心业务需求
3. 提取关键业务规则
4. 识别相关上下文

### Step 1.2：确定设计范围

| 设计类型 | 说明 | 特殊考虑 |
|---------|------|---------|
| **新功能** | 全新设计 | 需要完整的四部分设计 |
| **迭代** | 在现有设计基础上增加 | 重点说明变更部分 |
| **重构** | 改进现有设计 | 需要对比新旧设计 |

### Step 1.3：准备模板

1. 读取 `domain-design-template.md`
2. 确定需要填写的章节
3. 准备相关的原则和模式文档

---

## 阶段 2：按部分逐个设计

### 通用设计原则

每部分设计时必须遵循：

1. **理论依据**：每个设计决策都有明确的理论来源
2. **最佳实践**：符合业内公认的设计模式
3. **可验证性**：设计可转化为测试用例
4. **可追溯性**：设计可追溯到 PRD 需求

### 2.1 第一部分：战略设计

#### 设计原则

参见 [principles/strategic-principles.md](../principles/strategic-principles.md)

#### 设计完成后

使用 [checklists/strategic-checklist.md](../checklists/strategic-checklist.md) 自检。

#### 评分计算

见 [scoring/strategic-scoring.md](../scoring/strategic-scoring.md)

#### 及格线

- **及格分**：60 分
- **推荐分**：80 分以上

---

### 2.2 第二部分：战术设计

#### 设计原则

参见 [principles/tactical-principles.md](../principles/tactical-principles.md)

#### 设计完成后

使用 [checklists/tactical-checklist.md](../checklists/tactical-checklist.md) 自检。

#### 评分计算

见 [scoring/tactical-scoring.md](../scoring/tactical-scoring.md)

#### 及格线

- **及格分**：60 分
- **推荐分**：85 分以上

---

### 2.3 第三部分：约束定义

#### 设计原则

参见 [principles/constraint-principles.md](../principles/invariant-principles.md)

#### 设计完成后

使用 [checklists/constraint-checklist.md](../checklists/constraint-checklist.md) 自检。

#### 评分计算

见 [scoring/constraint-scoring.md](../scoring/constraint-scoring.md)

#### 及格线

- **及格分**：60 分
- **推荐分**：85 分以上

---

### 2.4 第四部分：用例设计

#### 设计原则

参见 [principles/usecase-principles.md](../principles/usecase-principles.md)

#### 设计完成后

使用 [checklists/usecase-checklist.md](../checklists/usecase-checklist.md) 自检。

#### 评分计算

见 [scoring/usecase-scoring.md](../scoring/usecase-scoring.md)

#### 及格线

- **及格分**：60 分
- **推荐分**：85 分以上

---

## 阶段 3：综合评分

### 3.1 加权计算公式

```
总分 = Part-1 × 20% + Part-2 × 30% + Part-3 × 25% + Part-4 × 25%
```

### 3.2 及格标准

| 条件 | 说明 |
|------|------|
| **硬性要求** | 每一部分 ≥ 60 分 |
| **交付要求** | 总分 ≥ 90 分 |
| **优秀标准** | 总分 ≥ 95 分 |

### 3.3 不合格处理

1. **单部分 < 60 分**：
   - 重新设计该部分
   - 对照检查清单逐项改进
   - 重新评分直到 ≥ 60 分

2. **总分 < 90 分**：
   - 识别最低分部分
   - 优先改进最低分部分（提升空间最大）
   - 重新计算总分直到 ≥ 90 分

### 3.4 迭代模式

当总分 < 90 分时，按以下优先级迭代：

1. **优先改进权重高的部分**：
   - 第二部分（30% 权重）
   - 第三部分（25% 权重）
   - 第四部分（25% 权重）
   - 第一部分（20% 权重）

2. **优先改进分数低的部分**：
   - 先改进 < 70 分的部分
   - 再改进 70-80 分的部分
   - 最后微调 80-85 分的部分

---

## 阶段 4：交付前检查

### 4.1 生成交付报告

交付报告格式：

```markdown
# 领域设计文档 - 评分报告

## 文档信息

- **文档名称**：{功能名称} - 领域设计文档
- **版本**：v1.0
- **创建时间**：{YYYY-MM-DD}
- **设计范围**：{新功能/迭代/重构}

## 评分详情

### 各部分得分

| 部分 | 满分 | 得分 | 得分率 | 权重 | 加权得分 |
|------|------|------|--------|------|----------|
| 第一部分（战略设计） | 100 | {得分} | {得分率}% | 20% | {加权得分} |
| 第二部分（战术设计） | 100 | {得分} | {得分率}% | 30% | {加权得分} |
| 第三部分（约束定义） | 100 | {得分} | {得分率}% | 25% | {加权得分} |
| 第四部分（用例设计） | 100 | {得分} | {得分率}% | 25% | {加权得分} |

### 总分

**总分**：{总分} / 100

**评级**：{优秀/良好/合格/不合格}

### 评分详情

#### 第一部分：战略设计（{得分} 分）

- [x] 业务能力分析：{得分} 分
- [x] 限界上下文划分：{得分} 分
- [x] 上下文映射：{得分} 分

**优点**：{列举优点}
**建议**：{列举改进建议}

#### 第二部分：战术设计（{得分} 分）

- [x] 聚合设计：{得分} 分
- [x] 实体/值对象：{得分} 分
- [x] 领域事件：{得分} 分
- [x] 领域服务：{得分} 分
- [x] 仓储接口：{得分} 分
- [x] 应用层接口：{得分} 分

**优点**：{列举优点}
**建议**：{列举改进建议}

#### 第三部分：约束定义（{得分} 分）

- [x] 状态定义：{得分} 分
- [x] 状态转移：{得分} 分
- [x] 不变量定义：{得分} 分
- [x] 禁止态说明：{得分} 分
- [x] 约束执行时机：{得分} 分
- [x] 约束违反处理：{得分} 分

**优点**：{列举优点}
**建议**：{列举改进建议}

#### 第四部分：用例设计（{得分} 分）

- [x] 正向用例：{得分} 分
- [x] Bad Case：{得分} 分
- [x] 边界用例：{得分} 分
- [x] 用例覆盖矩阵：{得分} 分
- [x] 用例优先级：{得分} 分

**优点**：{列举优点}
**建议**：{列举改进建议}

## 已知问题和建议

### 待讨论问题

1. {问题1}
2. {问题2}

### 优化建议

1. {建议1}
2. {建议2}

## 附录：评分标准

各部分详细评分标准参见：
- [战略设计评分标准](../scoring/strategic-scoring.md)
- [战术设计评分标准](../scoring/tactical-scoring.md)
- [约束定义评分标准](../scoring/constraint-scoring.md)
- [用例设计评分标准](../scoring/usecase-scoring.md)
```

### 4.2 交付检查清单

在提交用户 Review 前，确认：

- [ ] 总分 ≥ 90 分
- [ ] 每部分 ≥ 60 分
- [ ] 交付报告已生成
- [ ] 已知问题已列出
- [ ] 优化建议已提供
- [ ] 文档格式正确
- [ ] 所有引用链接有效

---

## 迭代模式说明

### 触发条件

用户要求修改设计，或自检发现问题时。

### 迭代流程

1. **识别需要修改的部分**
2. **读取当前文档**
3. **根据反馈/问题进行修改**
4. **重新使用对应检查清单评分**
5. **重新计算总分**
6. **如果总分提升，继续；否则尝试其他改进方向**
7. **达到 90 分后，生成交付报告**

### 迭代最佳实践

1. **小步迭代**：每次只修改一个问题
2. **保持可追溯**：记录每次修改的原因
3. **重新评分**：每次修改后都要重新评分
4. **避免回退**：新版本必须 ≥ 旧版本分数

---

## 常见错误

### ❌ 错误 1：跳过自检直接交付

**问题**：不使用检查清单自检就直接交付。

**后果**：文档质量不达标，需要大量返工。

**正确做法**：
- 每部分完成后立即使用对应检查清单评分
- 任一部分 < 60 分必须重新设计
- 总分 < 90 分必须迭代改进

### ❌ 错误 2：忽视理论依据

**问题**：设计决策没有说明理论来源。

**后果**：设计缺乏说服力，难以被评审接受。

**正确做法**：
- 每个设计决策都引用理论来源
- 引用权威著作（Eric Evans、Martin Fowler 等）
- 说明为什么选择这种设计模式

### ❌ 错误 3：约束不可验证

**问题**：约束描述模糊，无法写成 assert。

**后果**：无法转化为测试，设计质量低。

**正确做法**：
- 每个约束都通过三测试（可执行、可测试、可解释）
- 使用伪代码定义约束
- 提供验证用例

---

## 参考文档

- [各部分设计原则](../principles/)
- [各部分检查清单](../checklists/)
- [各部分评分标准](../scoring/)
- [领域设计文档模板](../templates/domain-design-template.md)
