# 第四章：应用层设计

## 章节目标

完成应用层设计，包括：
1. **应用服务列表**：列出所有应用服务
2. **用户行为列表**：列出用户操作
3. **系统行为列表**：列出系统操作
4. **事件处理**：设计事件监听器，处理聚合根发布的领域事件
5. **服务详细设计**：设计每个应用服务的方法、职责、约束
6. **服务用例设计**：设计每个应用服务的方法设计测试用例

---

## 1. 应用服务列表

| 服务名称 | 职责 | 对应聚合 | 对应领域服务 |
|---------|------|---------|-------------|
| {服务1} | {职责描述} | {聚合A} | {领域服务X} |
| {服务2} | {职责描述} | {聚合B} | - |

---
用户行为列表

| 行为名称 | 应用服务 | 聚合根方法 | 权限要求 |
|---------|---------|-----------|---------|
| {行为1} | {服务A} | {方法X} | {权限要求} |
| {行为2} | {服务B} | {方法Y} | {权限要求} |

系统行为列表

| 行为名称 | 触发条件 | 应用服务 | 聚合根方法 |
|---------|---------|---------|-----------|
| {行为1} | {触发条件} | {服务A} | {方法X} |
| {行为2} | {触发条件} | {服务B} | {方法Y} |

领域事件处理行为列表

| 监听的领域事件 | 处理逻辑 | 影响的聚合 | 所属应用服务 |
|---------|---------|-----------|-------------|
| {事件1}   | {逻辑描述} | {聚合A} | {当前服务} |
| {事件2}   | {逻辑描述} | {聚合B} | {当前服务} |

---

## 2. 应用服务详细设计



### 2.1 服务：{服务名称}

**基本信息**

| 字段 | 值 |
|------|-----|
| 服务名称 | {服务名称} |
| 职责 | {职责描述} |
| 对应聚合 | {聚合A} |
| 对应领域服务 | {领域服务X} |

**方法列表**

| 方法名 | 职责 | 调用的领域方法 |
|-------|------|--------------|
| {方法1} | {职责描述} | {聚合根}.{方法X}() |

---

#### 2.1.1 方法：{方法名1}(cmd)

**方法签名**

```typescript
async {方法名}(cmd: {Command类型}): Promise<{Result类型}>
```

**业务含义**

{方法的业务含义描述}

**处理逻辑**：{详细描述处理步骤}

**处理步骤**：

1. 参数接收：参数
2. 参数校验：
   - 校验 {字段1} 不为空
   - 校验 {字段2} 符合格式
3. 并发校验：
   - 分布式锁 ID：`{聚合根ID}`
   - 获取失败世界返回
4. 幂等性检查：
   - 幂等键：`{方法名}:{requestId}`
   - 已处理则直接返回
5. 调用领域服务/聚合：
   - 调用 {服务/聚合}.{方法}({参数})
6. 结果持久化：
   - 成功：标记已处理，记录日志
   - 失败：记录错误日志，根据配置决定是否重试
7. 发送领域事件（聚合根产生事件，在应用层发送）
8. 异常处理：
   - 持久化失败处理
   - 事件发送失败处理
   - 业务逻辑异常处理

**约束定义**

| 约束ID | 类型 | 描述 | 伪代码 | 执行时机 |
|-------|------|------|-------|---------|
| APP-{服务缩写}-01 | 参数校验 | {约束描述} | `ASSERT {条件表达式}` | 执行时 |
| APP-{服务缩写}-02 | 权限校验 | {约束描述} | `ASSERT {条件表达式}` | 执行时 |




## 3. 应用服务用例设计

### 3.1 服务：{服务名称}

#### 3.1.1 方法：{方法名1}(cmd)

**Case-APP-N1: {正向场景}**

| Given | When | Then | 验证约束 |
|-------|------|------|---------|
| {前置状态} | {方法名}({参数}={值}) | {结果描述} | APP-{服务缩写}-01 ✓ |
| {前置状态} | {方法名}({参数}={值}) | {结果描述} | APP-{服务缩写}-01 ✓ |

**Case-APP-B1: {约束违反场景}**

| Given | When | Then | 违反约束 |
|-------|------|------|---------|
| {前置状态} | {方法名}({参数}={非法值}) | 拒绝，"{错误信息}" | APP-{服务缩写}-01 ✗ |
| {前置状态} | {方法名}({参数}={非法值}) | 拒绝，"{错误信息}" | APP-{服务缩写}-01 ✗ |

**Case-APP-E1: 边界场景**

| Given | When | Then | 验证约束 |
|-------|------|------|---------|
| {边界条件} | {方法名}({参数}={边界值}) | {结果描述} | APP-{服务缩写}-01 ✓ |
| {边界条件} | {方法名}({参数}={边界值}) | {结果描述} | APP-{服务缩写}-01 ✓ |

