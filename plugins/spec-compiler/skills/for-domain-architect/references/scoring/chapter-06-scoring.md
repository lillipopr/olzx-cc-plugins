# 第六章评分标准：入口层设计

> **满分**：100 分
> **及格分**：60 分
> **优秀线**：80 分
> **对应章节**：chapter-06-starter.md
> **对应原则**：starter.md

---

## 评分维度

| 维度 | 权重 | 评分要点 |
|------|------|---------|
| 入口层核心原则 | 15 分 | 薄入口层、统一响应格式、异常处理 |
| Controller 层设计 | 30 分 | 只允许 POST、接口路径、请求参数、命名 |
| MQ 层设计 | 15 分 | 消费者设计、幂等性、异常处理 |
| Task 层设计 | 15 分 | 定时任务设计、分布式锁、任务监控 |
| 数据模型转换 | 10 分 | DTO 使用、参数校验分层 |
| 接口文档 | 15 分 | 文档完整性、版本控制 |

---

## 一、入口层核心原则（15 分）

### 1.1 薄入口层（8 分）

**满分**：8 分

**评分标准**：
- 优秀（90-100分）：所有入口都是薄入口层
- 良好（80-89分）：90%以上入口是薄入口层
- 及格（60-79分）：70%以上入口是薄入口层
- 不及格（<60分）：低于70%入口是薄入口层

**检查项**：
- [ ] 参数校验（2分）
- [ ] 调用应用层（3分）
- [ ] 返回结果（3分）
- [ ] 不包含业务逻辑（3分）

**示例**：
```typescript
// ✅ 正确：薄入口层
@Post("/memberships")
async createMembership(@Body() cmd: CreateMembershipRequest): Promise<ApiResponse<MembershipDTO>> {
  // 1. 参数校验
  this.validate(cmd)

  // 2. 调用应用层
  const membership = await this.membershipAppService.createMembership(cmd)

  // 3. 返回结果
  return ApiResponse.success(this.toDTO(membership))
}

// ❌ 错误：入口层包含业务逻辑
@Post("/memberships")
async createMembership(@Body() cmd: CreateMembershipRequest): Promise<ApiResponse<MembershipDTO>> {
  // 业务逻辑应该在应用层或领域层
  if (cmd.level === "VIP" && cmd.years < 1) {
    throw new Error("VIP 会员至少订阅 1 年")
  }

  const membership = await this.membershipAppService.createMembership(cmd)
  return ApiResponse.success(this.toDTO(membership))
}
```

**扣分项**：
- 入口层包含业务逻辑：扣 4 分/处

---

### 1.2 统一响应格式（4 分）

**满分**：4 分

**评分标准**：
- 优秀（90-100分）：所有接口都返回统一响应结构
- 良好（80-89分）：90%以上接口返回统一响应结构
- 及格（60-79分）：70%以上接口返回统一响应结构
- 不及格（<60分）：低于70%接口返回统一响应结构

**检查项**：
- [ ] 统一响应结构（4分）

**响应结构**：
```typescript
interface ApiResponse<T> {
  code: number          // 业务状态码
  message: string       // 响应消息
  data?: T             // 业务数据
}
```

**扣分项**：
- 响应格式不统一：扣 2 分/处

---

### 1.3 异常处理（3 分）

**满分**：3 分

**评分标准**：
- 优秀（90-100分）：异常处理完全统一
- 良好（80-89分）：90%以上异常处理统一
- 及格（60-79分）：70%以上异常处理统一
- 不及格（<60分）：低于70%异常处理统一

**检查项**：
- [ ] 统一的异常处理（3分）

**异常映射**：
| 异常类型 | HTTP 状态码 | 业务状态码 | 错误信息 |
|---------|-----------|-----------|---------|
| 参数校验失败 | 200 | 400 | "参数错误：{详细说明}" |
| 权限不足 | 200 | 403 | "权限不足" |
| 业务规则违反 | 200 | 422 | "{业务错误信息}" |
| 系统错误 | 200 | 500 | "系统错误，请稍后重试" |

**扣分项**：
- 异常处理不统一：扣 2 分/处

---

## 二、Controller 层设计（30 分）

### 2.1 只允许 POST（6 分）

**满分**：6 分

**评分标准**：
- 优秀（90-100分）：所有接口都是 POST 方法
- 良好（80-89分）：90%以上接口是 POST 方法
- 及格（60-79分）：70%以上接口是 POST 方法
- 不及格（<60分）：低于70%接口是 POST 方法

**检查项**：
- [ ] 只允许 POST 接口（6分）
- [ ] 不使用 GET、PUT、DELETE

**原因**：
- POST 语义清晰：表示执行操作
- 统一风格：所有接口都是 POST
- 避免歧义：GET、PUT、DELETE 语义容易混淆

**扣分项**：
- 使用其他方法：使用 GET/PUT/DELETE 扣 3 分/处

---

### 2.2 接口路径设计（10 分）

**满分**：10 分

**评分标准**：
- 优秀（90-100分）：所有接口路径都符合规范
- 良好（80-89分）：90%以上接口路径符合规范
- 及格（60-79分）：70%以上接口路径符合规范
- 不及格（<60分）：低于70%接口路径符合规范

**检查项**：
- [ ] 路径格式正确（5分）：/api/版本/端/聚合名/动作
- [ ] 全小写（2分）：wallet、freeze、login
- [ ] 连字符分隔（1分）：daily-grant、expire-check
- [ ] 动词结尾（2分）：create、cancel、freeze、login

**路径格式**：
```
/api/{版本}/{端}/{聚合名}/{动作}
```

**组成部分**：
- api：固定前缀
- 版本：v1、v2、v3...
- 端：m（Mobile）、c（Client）、w（Web）、a（Admin）
- 聚合名：wallet、user、membership、order...
- 动作：freeze、login、create、cancel...

**路径示例**：
```
✅ 好的路径设计
POST /api/v1/m/wallet/freeze        // 移动端：冻结钱包
POST /api/v1/c/user/login           // 客户端：用户登录
POST /api/v1/m/membership/create    // 移动端：创建会员
POST /api/v1/a/order/cancel         // 管理端：取消订单

❌ 差的路径设计
GET /api/wallet/freeze              // 不使用 GET
POST /api/wallet/freeze             // 缺少版本号
POST /api/v1/wallet/freeze          // 缺少端标识
POST /wallet/freeze                 // 缺少前缀
```

**扣分项**：
- 路径格式错误：扣 3 分/处
- 大写字母：扣 1 分/处
- 使用驼峰：扣 1 分/处

---

### 2.3 请求参数设计（8 分）

**满分**：8 分

**评分标准**：
- 优秀（90-100分）：所有请求参数都符合规范
- 良好（80-89分）：90%以上请求参数符合规范
- 及格（60-79分）：70%以上请求参数符合规范
- 不及格（<60分）：低于70%请求参数符合规范

**检查项**：
- [ ] 参数命名格式（3分）：{动作} + {聚合名} + Param
- [ ] 不使用原始类型（3分）：不直接使用 string、number、boolean
- [ ] 使用 Request Body（2分）：不使用 URL 参数

**参数命名格式**：
```
格式：{动作} + {聚合名} + Param

✅ 好的参数命名
- CreateMembershipParam（创建会员）
- FreezeWalletParam（冻结钱包）
- CancelOrderParam（取消订单）
- LoginUserParam（用户登录）

❌ 差的参数命名
- CreateMembershipRequest（不是 Request，是 Param）
- MembershipDTO（DTO 是响应对象，不是请求参数）
```

**禁止原始类型**：
```typescript
// ✅ 正确：使用 Param 对象
@Post("/api/v1/m/wallet/freeze")
async freezeWallet(@Body() param: FreezeWalletParam): Promise<ApiResponse<void>> {
  // param 是对象类型
}

// ❌ 错误：使用原始数据类型
@Post("/api/v1/m/wallet/freeze")
async freezeWallet(@Body() walletId: string): Promise<ApiResponse<void>> {
  // 不应该直接使用 string
}
```

**扣分项**：
- 参数命名不规范：扣 2 分/个
- 使用原始类型：扣 3 分/个
- 使用 URL 参数：扣 2 分/个

---

### 2.4 Controller 命名（6 分）

**满分**：6 分

**评分标准**：
- 优秀（90-100分）：所有 Controller 命名都符合规范
- 良好（80-89分）：90%以上 Controller 命名符合规范
- 及格（60-79分）：70%以上 Controller 命名符合规范
- 不及格（<60分）：低于70% Controller 命名符合规范

**检查项**：
- [ ] 使用"聚合名 + Controller"格式（6分）

**命名规范**：
- ✅ 好的命名：MembershipController、CouponController、PaymentController
- ❌ 差的命名：MembershipService（与 Service 层混淆）、MembershipHandler（不明确）

**扣分项**：
- 命名不规范：扣 3 分/个

---

## 三、MQ 层设计（15 分）

### 3.1 消费者设计（5 分）

**满分**：5 分

**评分标准**：
- 优秀（90-100分）：所有消费者都是薄消费者
- 良好（80-89分）：90%以上消费者是薄消费者
- 及格（60-79分）：70%以上消费者是薄消费者
- 不及格（<60分）：低于70%消费者是薄消费者

**检查项**：
- [ ] 接收消息（2分）
- [ ] 调用应用层（2分）
- [ ] 确认消息（1分）
- [ ] 不包含业务逻辑（3分）

**示例**：
```typescript
// ✅ 正确：薄消费者
class MembershipEventHandler {
  async onMembershipActivated(event: MembershipActivated): Promise<void> {
    // 1. 消息校验
    this.validate(event)

    // 2. 调用应用层
    await this.couponAppService.startDailyGrant(event.membershipId)

    // 3. ACK 确认
    this.ack()
  }
}

// ❌ 错误：消费者包含业务逻辑
class MembershipEventHandler {
  async onMembershipActivated(event: MembershipActivated): Promise<void> {
    // 业务逻辑应该在应用层
    const coupon = await this.couponRepo.findByUserId(event.userId)
    coupon.addAmount(100)
    await this.couponRepo.save(coupon)
  }
}
```

**扣分项**：
- 消费者包含业务逻辑：扣 3 分/处

---

### 3.2 幂等性（5 分）

**满分**：5 分

**评分标准**：
- 优秀（90-100分）：所有消费者都保证幂等性
- 良好（80-89分）：90%以上消费者保证幂等性
- 及格（60-79分）：70%以上消费者保证幂等性
- 不及格（<60分）：低于70%消费者保证幂等性

**检查项**：
- [ ] 使用 eventId 作为幂等键（3分）
- [ ] 处理前检查是否已处理（2分）

**扣分项**：
- 未保证幂等性：扣 3 分/处

---

### 3.3 异常处理（5 分）

**满分**：5 分

**评分标准**：
- 优秀（90-100分）：所有消费者异常处理都正确
- 良好（80-89分）：90%以上消费者异常处理正确
- 及格（60-79分）：70%以上消费者异常处理正确
- 不及格（<60分）：低于70%消费者异常处理正确

**检查项**：
- [ ] 参数错误：发送到死信队列，告警，不重试
- [ ] 业务错误：发送到死信队列，告警，不重试
- [ ] 系统错误：重新入队（最多 N 次），重试
- [ ] 超过重试次数：发送到死信队列，告警，不重试

**扣分项**：
- 异常处理错误：扣 2 分/处

---

## 四、Task 层设计（15 分）

### 4.1 定时任务设计（5 分）

**满分**：5 分

**评分标准**：
- 优秀（90-100分）：所有定时任务都是薄任务
- 良好（80-89分）：90%以上定时任务是薄任务
- 及格（60-79分）：70%以上定时任务是薄任务
- 不及格（<60分）：低于70%定时任务是薄任务

**检查项**：
- [ ] 触发（2分）
- [ ] 调用应用层（2分）
- [ ] 记录日志（1分）
- [ ] 不包含业务逻辑（3分）

**示例**：
```typescript
// ✅ 正确：薄定时任务
@Cron("0 0 * * *")  // 每天凌晨执行
class ExpireMembershipTask {
  async execute(): Promise<void> {
    // 1. 获取分布式锁
    const lock = await this.lockManager.acquire("lock:task:expire-membership")
    if (!lock) {
      return  // 获取失败，跳过本次执行
    }

    try {
      // 2. 调用应用层
      await this.membershipAppService.expireMemberships()
    } finally {
      // 3. 释放锁
      await lock.release()
    }
  }
}

// ❌ 错误：定时任务包含业务逻辑
@Cron("0 0 * * *")
class ExpireMembershipTask {
  async execute(): Promise<void> {
    // 业务逻辑应该在应用层
    const memberships = await this.membershipRepo.findActive()
    for (const membership of memberships) {
      if (membership.isExpired()) {
        membership.expire()
        await this.membershipRepo.save(membership)
      }
    }
  }
}
```

**扣分项**：
- 定时任务包含业务逻辑：扣 3 分/处

---

### 4.2 分布式锁（5 分）

**满分**：5 分

**评分标准**：
- 优秀（90-100分）：所有定时任务都使用分布式锁
- 良好（80-89分）：90%以上定时任务使用分布式锁
- 及格（60-79分）：70%以上定时任务使用分布式锁
- 不及格（<60分）：低于70%定时任务使用分布式锁

**检查项**：
- [ ] 使用分布式锁（5分）

**扣分项**：
- 未使用分布式锁：扣 3 分/处

---

### 4.3 任务监控（5 分）

**满分**：5 分

**评分标准**：
- 优秀（90-100分）：所有定时任务都有监控指标
- 良好（80-89分）：90%以上定时任务有监控指标
- 及格（60-79分）：70%以上定时任务有监控指标
- 不及格（<60分）：低于70%定时任务有监控指标

**检查项**：
- [ ] 执行耗时：> 30 秒告警（2分）
- [ ] 失败次数：> 3 次/天告警（2分）
- [ ] 跳过次数：> 10 次/天告警（1分）

**扣分项**：
- 监控指标缺失：扣 2 分/个

---

## 五、数据模型转换（10 分）

### 5.1 DTO 使用（5 分）

**满分**：5 分

**评分标准**：
- 优秀（90-100分）：所有接口都使用 DTO，不直接使用领域模型
- 良好（80-89分）：90%以上接口使用 DTO
- 及格（60-79分）：70%以上接口使用 DTO
- 不及格（<60分）：低于70%接口使用 DTO

**检查项**：
- [ ] Request → Command（2分）
- [ ] Domain → DTO（2分）
- [ ] 不直接暴露领域模型（1分）

**扣分项**：
- 直接使用领域模型：扣 3 分/处

---

### 5.2 参数校验分层（5 分）

**满分**：5 分

**评分标准**：
- 优秀（90-100分）：参数校验分层完全清晰
- 良好（80-89分）：90%以上参数校验分层清晰
- 及格（60-79分）：70%以上参数校验分层清晰
- 不及格（<60分）：低于70%参数校验分层清晰

**检查项**：
- [ ] 入口层：格式校验（2分）：邮箱格式、手机号格式
- [ ] 入口层：参数校验（2分）：必填字段、数值范围
- [ ] 领域层：业务规则校验（1分）：会员只能有一个生效订阅

**扣分项**：
- 分层不清晰：扣 2 分/处

---

## 六、接口文档（15 分）

### 6.1 文档完整性（8 分）

**满分**：8 分

**评分标准**：
- 优秀（90-100分）：所有接口都有完整的文档
- 良好（80-89分）：90%以上接口有完整文档
- 及格（60-79分）：70%以上接口有完整文档
- 不及格（<60分）：低于70%接口有完整文档

**检查项**：
- [ ] 接口名称（1分）
- [ ] 接口描述（1分）
- [ ] 请求定义（2分）：Request Header、Request Body
- [ ] 响应定义（2分）：成功响应、失败响应
- [ ] 请求示例（1分）：JSON 示例
- [ ] 响应示例（1分）：JSON 示例

**扣分项**：
- 文档内容缺失：扣 1 分/项

---

### 6.2 版本控制（7 分）

**满分**：7 分

**评分标准**：
- 优秀（90-100分）：所有接口都有版本控制
- 良好（80-89分）：90%以上接口有版本控制
- 及格（60-79分）：70%以上接口有版本控制
- 不及格（<60分）：低于70%接口有版本控制

**检查项**：
- [ ] 使用路径版本控制（7分）：/api/v1/、/api/v2/

**版本控制示例**：
```
✅ 好的版本控制
POST /api/v1/memberships/create
POST /api/v2/memberships/create

❌ 差的版本控制
POST /api/memberships/create?v=1
POST /api/memberships/create  // 无版本控制
```

**扣分项**：
- 无版本控制：扣 4 分/个
- 使用查询参数版本控制：扣 2 分/个

---

## 快速评分表

| 检查项 | 分值 | 得分 | 备注 |
|--------|------|------|------|
| **入口层核心原则** | | | |
| 参数校验 | 2 | __ | 薄入口层 |
| 调用应用层 | 3 | __ | 薄入口层 |
| 返回结果 | 3 | __ | 薄入口层 |
| 不包含业务逻辑 | 3 | __ | 薄入口层 |
| 统一响应结构 | 4 | __ | 统一响应格式 |
| 统一异常处理 | 3 | __ | 异常处理 |
| **Controller 层设计** | | | |
| 只允许 POST | 6 | __ | 只允许 POST |
| 路径格式正确 | 5 | __ | 接口路径 |
| 全小写 | 2 | __ | 接口路径 |
| 连字符分隔 | 1 | __ | 接口路径 |
| 动词结尾 | 2 | __ | 接口路径 |
| 参数命名格式 | 3 | __ | 请求参数 |
| 不使用原始类型 | 3 | __ | 请求参数 |
| 使用 Request Body | 2 | __ | 请求参数 |
| Controller 命名 | 6 | __ | Controller 命名 |
| **MQ 层设计** | | | |
| 接收消息 | 2 | __ | 消费者设计 |
| 调用应用层 | 2 | __ | 消费者设计 |
| 确认消息 | 1 | __ | 消费者设计 |
| 不包含业务逻辑 | 3 | __ | 消费者设计 |
| eventId 幂等键 | 3 | __ | 幂等性 |
| 检查是否已处理 | 2 | __ | 幂等性 |
| 异常处理正确 | 5 | __ | 异常处理 |
| **Task 层设计** | | | |
| 触发 | 2 | __ | 定时任务设计 |
| 调用应用层 | 2 | __ | 定时任务设计 |
| 记录日志 | 1 | __ | 定时任务设计 |
| 不包含业务逻辑 | 3 | __ | 定时任务设计 |
| 使用分布式锁 | 5 | __ | 分布式锁 |
| 执行耗时监控 | 2 | __ | 任务监控 |
| 失败次数监控 | 2 | __ | 任务监控 |
| 跳过次数监控 | 1 | __ | 任务监控 |
| **数据模型转换** | | | |
| Request → Command | 2 | __ | DTO 使用 |
| Domain → DTO | 2 | __ | DTO 使用 |
| 不直接暴露领域模型 | 1 | __ | DTO 使用 |
| 格式校验 | 2 | __ | 参数校验分层 |
| 参数校验 | 2 | __ | 参数校验分层 |
| 业务规则校验 | 1 | __ | 参数校验分层 |
| **接口文档** | | | |
| 接口名称 | 1 | __ | 文档完整性 |
| 接口描述 | 1 | __ | 文档完整性 |
| 请求定义 | 2 | __ | 文档完整性 |
| 响应定义 | 2 | __ | 文档完整性 |
| 请求示例 | 1 | __ | 文档完整性 |
| 响应示例 | 1 | __ | 文档完整性 |
| 路径版本控制 | 7 | __ | 版本控制 |
| **总计** | 100 | __ | |

---

## 及格标准

- **章节及格线**：60 分
- **优秀线**：80 分
- **核心项必须通过**：
  - 不包含业务逻辑 ≥ 5 分
  - 只允许 POST ≥ 5 分
  - 路径格式正确 ≥ 4 分
  - 不使用原始类型 ≥ 6 分
  - 不包含业务逻辑（消费者） ≥ 5 分
  - 使用分布式锁 ≥ 4 分

---

## 评分示例

### 优秀示例（96 分）

**场景**：会员订阅入口层设计

**评分过程**：
1. 入口层核心原则：15/15 分
   - 薄入口层：8/8 分（完全符合）
   - 统一响应格式：4/4 分（完全统一）
   - 异常处理：3/3 分（完全统一）

2. Controller 层设计：29/30 分
   - 只允许 POST：6/6 分（所有接口都是 POST）
   - 接口路径设计：10/10 分（路径完全符合规范）
   - 请求参数设计：7/8 分（基本符合规范，扣1分因为有一个参数命名略长）
   - Controller 命名：6/6 分（命名完全符合规范）

3. MQ 层设计：15/15 分
   - 消费者设计：5/5 分（所有消费者都是薄消费者）
   - 幂等性：5/5 分（所有消费者都保证幂等性）
   - 异常处理：5/5 分（异常处理完全正确）

4. Task 层设计：15/15 分
   - 定时任务设计：5/5 分（所有定时任务都是薄任务）
   - 分布式锁：5/5 分（所有定时任务都使用分布式锁）
   - 任务监控：5/5 分（所有定时任务都有监控指标）

5. 数据模型转换：10/10 分
   - DTO 使用：5/5 分（所有接口都使用 DTO）
   - 参数校验分层：5/5 分（分层完全清晰）

6. 接口文档：12/15 分
   - 文档完整性：7/8 分（基本完整，扣1分因为有一个接口缺少响应示例）
   - 版本控制：5/7 分（基本有版本控制，扣2分因为有两个接口版本号不一致）

**总分**：96/100 分（优秀）

**改进建议**：
1. 优化参数命名长度
2. 补充响应示例
3. 统一版本号

---

## 原则追溯

本评分标准基于以下原则：
- starter.md 1.1-1.3：入口层核心原则
- starter.md 2.1-2.4：Controller 层原则
- starter.md 2.3：请求参数设计原则
- starter.md 3.1-3.3：MQ 层原则
- starter.md 4.1-4.3：Task 层原则
- starter.md 5.1-5.2：入口层与领域层分离原则
- starter.md 6.1-6.2：接口文档原则

---

## 检查清单对应

本评分标准与 chapter-06-checklist.md 对应：
- 入口层核心原则 → 检查清单第 1 节
- Controller 层设计 → 检查清单第 2-4 节
- MQ 层设计 → 检查清单第 5 节
- Task 层设计 → 检查清单第 6 节
- 数据模型转换 → 检查清单第 7 节
- 接口文档 → 检查清单第 8 节
