# 第五章评分标准：领域事件设计

> **满分**：100 分
> **及格分**：60 分
> **优秀线**：80 分
> **对应章节**：chapter-05-domain-event.md
> **对应原则**：domain-event.md

---

## 评分维度

| 维度 | 权重 | 评分要点 |
|------|------|---------|
| 领域事件特征 | 20 分 | 核心特征、与命令区分 |
| 领域事件识别 | 20 分 | 识别时机、识别问题 |
| 领域事件命名 | 10 分 | 命名格式、命名验证 |
| 领域事件设计 | 20 分 | 事件结构、数据最少原则、不可变性 |
| 领域事件发布 | 15 分 | 发布位置、发布时机 |
| 领域事件订阅 | 15 分 | 订阅方处理、幂等性、异常处理 |

---

## 一、领域事件特征（20 分）

### 1.1 核心特征（10 分）

**满分**：10 分

**评分标准**：
- 优秀（90-100分）：所有领域事件都满足核心特征
- 良好（80-89分）：90%以上领域事件满足核心特征
- 及格（60-79分）：70%以上领域事件满足核心特征
- 不及格（<60分）：低于70%领域事件满足核心特征

**检查项**：
- [ ] 已经发生（2分）：表示过去的事实
- [ ] 不可变（2分）：一旦发生不能改变
- [ ] 业务相关（2分）：表达业务含义
- [ ] 携带数据（2分）：包含必要业务数据
- [ ] 有唯一标识（2分）：每个事件有唯一 ID

**扣分项**：
- 特征缺失：缺少核心特征扣 2 分/个

---

### 1.2 与命令区分（10 分）

**满分**：10 分

**评分标准**：
- 优秀（90-100分）：领域事件与命令完全正确区分
- 良好（80-89分）：90%以上正确区分
- 及格（60-79分）：70%以上正确区分
- 不及格（<60分）：低于70%正确区分

**检查项**：
- [ ] 时态区分（3分）：事件是过去式（已做），命令是将来式（要做）
- [ ] 来源区分（2分）：事件由聚合发布，命令由用户/系统发起
- [ ] 数量区分（2分）：事件唯一确定，命令可能多个
- [ ] 处理区分（2分）：事件必须成功，命令可以失败
- [ ] 命名区分（1分）：MembershipActivated vs ActivateMembership

**对比表**：
| 维度 | 命令（Command） | 事件（Event） |
|------|-----------------|---------------|
| 时态 | 将来时（要做） | 过去时（已做） |
| 命名 | ActivateMembership | MembershipActivated |
| 来源 | 用户/系统发起 | 聚合发布 |
| 数量 | 可能多个 | 唯一确定 |
| 处理 | 可以失败 | 必须成功 |
| 示例 | "激活会员" | "会员已激活" |

**扣分项**：
- 与命令混淆：事件和命令混淆扣 3 分/处

---

## 二、领域事件识别（20 分）

### 2.1 识别时机（10 分）

**满分**：10 分

**评分标准**：
- 优秀（90-100分）：在所有正确时机使用领域事件
- 良好（80-89分）：90%以上时机正确
- 及格（60-79分）：70%以上时机正确
- 不及格（<60分）：低于70%时机正确

**检查项**：
- [ ] 状态变化（3分）：聚合状态发生重要变化
- [ ] 跨边界协作（3分）：需要通知其他上下文
- [ ] 异步处理（2分）：触发后台任务
- [ ] 审计追踪（2分）：记录关键操作

**扣分项**：
- 时机错误：在错误时机使用事件扣 3 分/处
- 时机缺失：应该在某个时机使用事件但未使用扣 3 分/处

---

### 2.2 识别问题（10 分）

**满分**：10 分

**评分标准**：
- 优秀（90-100分）：使用问题清单验证所有事件
- 良好（80-89分）：90%以上事件通过问题清单验证
- 及格（60-79分）：70%以上事件通过问题清单验证
- 不及格（<60分）：低于70%事件通过问题清单验证

**检查项**：
- [ ] 这个事情重要到需要通知其他部分吗？（3分）
- [ ] 这个事情是一个已经发生的事实吗？（2分）
- [ ] 其他上下文需要对这个事情做出反应吗？（3分）
- [ ] 需要审计追踪这个事情吗？（2分）

**扣分项**：
- 未使用问题清单：扣 4 分
- 问题清单应用错误：扣 2 分/处

---

## 三、领域事件命名（10 分）

### 3.1 命名格式（6 分）

**满分**：6 分

**评分标准**：
- 优秀（90-100分）：所有事件命名完全符合格式
- 良好（80-89分）：90%以上事件命名符合格式
- 及格（60-79分）：70%以上事件命名符合格式
- 不及格（<60分）：低于70%事件命名符合格式

**检查项**：
- [ ] 使用"聚合根 + 过去式动词 + Event"格式（6分）

**命名规范**：
- ✅ 好的事件命名：MembershipActivatedEvent、OrderPaidEvent、CouponExpiredEvent
- ❌ 差的事件命名：ActivateMembershipEvent（命令，不是事件）、MembershipActivationEvent（缺少动词）、会员激活Event（中文，不符合代码规范）

**扣分项**：
- 命名不规范：扣 3 分/个
- 使用中文：扣 2 分/个

---

### 3.2 命名验证（4 分）

**满分**：4 分

**评分标准**：
- 优秀（90-100分）：所有事件命名都通过验证
- 良好（80-89分）：90%以上事件命名通过验证
- 及格（60-79分）：70%以上事件命名通过验证
- 不及格（<60分）：低于70%事件命名通过验证

**检查项**：
- [ ] 事件命名不是命令（4分）

**扣分项**：
- 事件命名是命令：扣 3 分/个

---

## 四、领域事件设计（20 分）

### 4.1 事件结构（7 分）

**满分**：7 分

**评分标准**：
- 优秀（90-100分）：所有事件都包含必要业务数据
- 良好（80-89分）：90%以上事件包含必要数据
- 及格（60-79分）：70%以上事件包含必要数据
- 不及格（<60分）：低于70%事件包含必要数据

**检查项**：
- [ ] eventId（2分）：事件唯一标识
- [ ] 聚合根 ID（2分）：关联的聚合根
- [ ] 业务数据（2分）：必要的信息
- [ ] 时间戳（1分）：事件发生时间

**示例**：
```typescript
// ✅ 正确：事件包含必要数据
interface MembershipActivated {
  eventId: string
  membershipId: string
  userId: string
  level: MembershipLevel
  activatedAt: Date
}

// ❌ 错误：事件数据不足
interface MembershipActivated {
  eventId: string
  // 缺少 userId、level 等关键数据
}
```

**扣分项**：
- 数据缺失：缺少必要字段扣 2 分/个

---

### 4.2 数据最少原则（7 分）

**满分**：7 分

**评分标准**：
- 优秀（90-100分）：所有事件只携带订阅方需要的数据
- 良好（80-89分）：90%以上事件遵循数据最少原则
- 及格（60-79分）：70%以上事件遵循数据最少原则
- 不及格（<60分）：低于70%事件遵循数据最少原则

**检查项**：
- [ ] 不携带整个聚合（4分）
- [ ] 只包含必要字段（3分）

**示例**：
```typescript
// ✅ 正确：只携带必要数据
interface MembershipActivated {
  eventId: string
  membershipId: string
  userId: string
  level: MembershipLevel
  activatedAt: Date
}

// ❌ 错误：携带整个聚合
interface MembershipActivated {
  eventId: string
  membership: Membership  // 不应该携带整个聚合
}
```

**扣分项**：
- 携带整个聚合：扣 4 分/个
- 携带不必要数据：扣 2 分/个

---

### 4.3 不可变性（6 分）

**满分**：6 分

**评分标准**：
- 优秀（90-100分）：所有事件都是不可变的
- 良好（80-89分）：90%以上事件是不可变的
- 及格（60-79分）：70%以上事件是不可变的
- 不及格（<60分）：低于70%事件是不可变的

**检查项**：
- [ ] 使用 readonly 修饰属性（4分）
- [ ] 事件一旦发布不能修改（2分）

**示例**：
```typescript
// ✅ 正确：事件不可变
class MembershipActivated {
  readonly eventId: string
  readonly membershipId: string
  readonly userId: string
  readonly level: MembershipLevel
  readonly activatedAt: Date
}
```

**扣分项**：
- 事件可变：事件属性可变扣 4 分/个

---

## 五、领域事件发布（15 分）

### 5.1 发布位置（8 分）

**满分**：8 分

**评分标准**：
- 优秀（90-100分）：所有事件都在聚合根方法中发布
- 良好（80-89分）：90%以上事件在聚合根方法中发布
- 及格（60-79分）：70%以上事件在聚合根方法中发布
- 不及格（<60分）：低于70%事件在聚合根方法中发布

**检查项**：
- [ ] 在聚合根方法中发布（8分）

**示例**：
```typescript
// ✅ 正确：在聚合根方法中发布事件
class Membership {
  activate(): void {
    this.status = MembershipStatus.ACTIVE
    // 发布事件
    this.addEvent(new MembershipActivated(
      uuid(),
      this.id.value,
      this.userId.value,
      this.level,
      new Date()
    ))
  }
}
```

**扣分项**：
- 发布位置错误：不在聚合根方法中发布扣 4 分/处

---

### 5.2 发布时机（7 分）

**满分**：7 分

**评分标准**：
- 优秀（90-100分）：所有事件都在状态变更完成后发布
- 良好（80-89分）：90%以上事件发布时机正确
- 及格（60-79分）：70%以上事件发布时机正确
- 不及格（<60分）：低于70%事件发布时机正确

**检查项**：
- [ ] 状态变更完成后发布（7分）

**示例**：
```typescript
// ✅ 正确：状态变更完成后发布事件
class Membership {
  activate(): void {
    // 先修改状态
    this.status = MembershipStatus.ACTIVE
    // 然后发布事件
    this.addEvent(new MembershipActivated(...))
  }
}

// ❌ 错误：状态变更前发布事件
class Membership {
  activate(): void {
    // 先发布事件
    this.addEvent(new MembershipActivated(...))
    // 然后修改状态（如果修改失败，事件已发布）
    this.status = MembershipStatus.ACTIVE
  }
}
```

**扣分项**：
- 发布时机错误：状态变更前发布扣 4 分/处

---

## 六、领域事件订阅（15 分）

### 6.1 订阅方处理（5 分）

**满分**：5 分

**评分标准**：
- 优秀（90-100分）：所有订阅方都异步处理事件
- 良好（80-89分）：90%以上订阅方异步处理
- 及格（60-79分）：70%以上订阅方异步处理
- 不及格（<60分）：低于70%订阅方异步处理

**检查项**：
- [ ] 订阅方异步处理事件（5分）

**示例**：
```typescript
// ✅ 正确：异步处理事件
class CouponEventHandler {
  @EventListener
  async onMembershipActivated(event: MembershipActivated): Promise<void> {
    await this.couponService.startDailyGrant(event.membershipId)
  }
}
```

**扣分项**：
- 同步处理：订阅方同步处理事件扣 3 分/处

---

### 6.2 幂等性（5 分）

**满分**：5 分

**评分标准**：
- 优秀（90-100分）：所有订阅方都保证幂等性
- 良好（80-89分）：90%以上订阅方保证幂等性
- 及格（60-79分）：70%以上订阅方保证幂等性
- 不及格（<60分）：低于70%订阅方保证幂等性

**检查项**：
- [ ] 使用 eventId 作为幂等键（3分）
- [ ] 处理前检查是否已处理（2分）

**示例**：
```typescript
// ✅ 正确：保证幂等性
class CouponEventHandler {
  async onMembershipActivated(event: MembershipActivated): Promise<void> {
    const idempotentKey = `membership:activated:${event.eventId}`
    const exists = await this.idempotentRepo.exists(idempotentKey)
    if (exists) {
      return  // 已处理，直接返回
    }

    await this.couponService.startDailyGrant(event.membershipId)
    await this.idempotentRepo.save(idempotentKey)
  }
}
```

**扣分项**：
- 未保证幂等性：扣 3 分/处

---

### 6.3 异常处理（5 分）

**满分**：5 分

**评分标准**：
- 优秀（90-100分）：所有订阅方异常都不影响发布方
- 良好（80-89分）：90%以上订阅方异常不影响发布方
- 及格（60-79分）：70%以上订阅方异常不影响发布方
- 不及格（<60分）：低于70%订阅方异常不影响发布方

**检查项**：
- [ ] try-catch 捕获异常（3分）
- [ ] 记录日志但不向上抛出（2分）

**示例**：
```typescript
// ✅ 正确：订阅方异常不影响发布方
class CouponEventHandler {
  async onMembershipActivated(event: MembershipActivated): Promise<void> {
    try {
      await this.couponService.startDailyGrant(event.membershipId)
    } catch (error) {
      // 记录日志，但不向上抛出异常
      this.logger.error("Failed to process event", error)
    }
  }
}
```

**扣分项**：
- 异常影响发布方：订阅方异常向上抛出扣 3 分/处

---

## 快速评分表

| 检查项 | 分值 | 得分 | 备注 |
|--------|------|------|------|
| **领域事件特征** | | | |
| 已经发生 | 2 | __ | 核心特征 |
| 不可变 | 2 | __ | 核心特征 |
| 业务相关 | 2 | __ | 核心特征 |
| 携带数据 | 2 | __ | 核心特征 |
| 有唯一标识 | 2 | __ | 核心特征 |
| 时态区分 | 3 | __ | 与命令区分 |
| 来源区分 | 2 | __ | 与命令区分 |
| 数量区分 | 2 | __ | 与命令区分 |
| 处理区分 | 2 | __ | 与命令区分 |
| 命名区分 | 1 | __ | 与命令区分 |
| **领域事件识别** | | | |
| 状态变化 | 3 | __ | 识别时机 |
| 跨边界协作 | 3 | __ | 识别时机 |
| 异步处理 | 2 | __ | 识别时机 |
| 审计追踪 | 2 | __ | 识别时机 |
| 问题清单验证 | 10 | __ | 识别问题 |
| **领域事件命名** | | | |
| 命名格式 | 6 | __ | "聚合根+过去式+Event" |
| 命名验证 | 4 | __ | 不是命令 |
| **领域事件设计** | | | |
| eventId | 2 | __ | 事件结构 |
| 聚合根ID | 2 | __ | 事件结构 |
| 业务数据 | 2 | __ | 事件结构 |
| 时间戳 | 1 | __ | 事件结构 |
| 不携带整个聚合 | 4 | __ | 数据最少原则 |
| 只包含必要字段 | 3 | __ | 数据最少原则 |
| readonly修饰 | 4 | __ | 不可变性 |
| 不能修改 | 2 | __ | 不可变性 |
| **领域事件发布** | | | |
| 在聚合根方法中 | 8 | __ | 发布位置 |
| 状态变更完成后 | 7 | __ | 发布时机 |
| **领域事件订阅** | | | |
| 异步处理 | 5 | __ | 订阅方处理 |
| eventId作为幂等键 | 3 | __ | 幂等性 |
| 检查是否已处理 | 2 | __ | 幂等性 |
| try-catch捕获 | 3 | __ | 异常处理 |
| 记录日志不抛出 | 2 | __ | 异常处理 |
| **总计** | 100 | __ | |

---

## 及格标准

- **章节及格线**：60 分
- **优秀线**：80 分
- **核心项必须通过**：
  - 核心特征 ≥ 7 分
  - 与命令区分 ≥ 7 分
  - 命名格式 ≥ 5 分
  - 不携带整个聚合 ≥ 4 分
  - 在聚合根方法中发布 ≥ 6 分
  - 幂等性 ≥ 4 分

---

## 评分示例

### 优秀示例（95 分）

**场景**：会员激活事件设计

**评分过程**：
1. 领域事件特征：19/20 分
   - 核心特征：10/10 分（满足所有核心特征）
   - 与命令区分：9/10 分（正确区分，扣1分因为有一个示例说明不够清晰）

2. 领域事件识别：19/20 分
   - 识别时机：10/10 分（在所有正确时机使用事件）
   - 识别问题：9/10 分（使用问题清单，扣1分因为有一个问题说明不够充分）

3. 领域事件命名：10/10 分
   - 命名格式：6/6 分（完全符合格式）
   - 命名验证：4/4 分（通过验证）

4. 领域事件设计：19/20 分
   - 事件结构：7/7 分（包含所有必要数据）
   - 数据最少原则：7/7 分（只携带必要数据）
   - 不可变性：5/6 分（基本不可变，扣1分因为有一个属性未使用 readonly）

5. 领域事件发布：15/15 分
   - 发布位置：8/8 分（在聚合根方法中发布）
   - 发布时机：7/7 分（状态变更完成后发布）

6. 领域事件订阅：13/15 分
   - 订阅方处理：5/5 分（异步处理）
   - 幂等性：5/5 分（保证幂等性）
   - 异常处理：3/5 分（有异常处理，扣2分因为有一处异常向上抛出）

**总分**：95/100 分（优秀）

**改进建议**：
1. 完善示例说明
2. 充分问题说明
3. 所有属性使用 readonly
4. 异常不向上抛出

---

## 原则追溯

本评分标准基于以下原则：
- domain-event.md 1.1-1.2：领域事件特征原则
- domain-event.md 2.1-2.2：领域事件识别原则
- domain-event.md 3.1-3.2：领域事件命名原则
- domain-event.md 4.1-4.3：领域事件设计原则
- domain-event.md 5.1-5.2：领域事件发布原则
- domain-event.md 6.1-6.3：领域事件订阅原则
- domain-event.md 7.1-7.2：常见领域事件类型

---

## 检查清单对应

本评分标准与 chapter-05-checklist.md 对应：
- 领域事件特征 → 检查清单第 1 节
- 领域事件识别 → 检查清单第 2 节
- 领域事件命名 → 检查清单第 3 节
- 领域事件设计 → 检查清单第 4 节
- 领域事件发布 → 检查清单第 5 节
- 领域事件订阅 → 检查清单第 6 节
- 常见事件类型 → 检查清单第 7 节
