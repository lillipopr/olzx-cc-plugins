# 第四章检查清单：应用层设计

## 使用说明
- **何时使用**：完成第四章（应用层）设计后
- **预计耗时**：5-10 分钟
- **通过标准**：所有核心项检查通过

---

## 核心检查项

### 1. 应用层职责

#### 核心职责
- [ ] 应用层职责清晰
  - 用例编排：协调多个领域对象
  - 事务管理：管理事务边界
  - 调用领域层：调用聚合根和领域服务
  - 发布领域事件：发布聚合根产生的事件
  - 返回结果：返回 DTO 或响应

#### 职责边界
- [ ] 应用层不包含业务逻辑
  - 业务逻辑在领域层
  - 应用层只负责编排

---

### 2. 用户行为 vs 系统行为

#### 行为分类
- [ ] 用户行为和系统行为已区分
  - 用户行为：用户操作触发、需要权限控制、需要参数校验
  - 系统行为：系统事件触发、无用户交互、无权限控制

#### 决策树
- [ ] 使用决策树验证行为分类
  - 由用户发起吗？→ 是 → 用户行为
  - 由事件触发吗？→ 是 → 系统行为
  - 由定时任务触发吗？→ 是 → 系统行为

---

### 3. 应用服务设计

#### 服务命名
- [ ] 应用服务命名符合规范
  - 格式：聚合名 + Application
  - 示例：MembershipApplication、CouponApplication
- [ ] 不与其他层混淆
  - 不使用 XxxService（与领域服务混淆）
  - 不使用 XxxController（Controller 层命名）

#### 方法命名
- [ ] 应用服务方法命名符合规范
  - 格式：动词+名词，表达用例意图
  - 示例：createMembership()、cancelMembership()、upgradeMembership()

#### 服务结构
- [ ] 应用服务方法遵循统一结构
  1. 参数校验
  2. 调用领域层
  3. 保存
  4. 发布事件
  5. 返回结果

---

### 4. 业务逻辑分层

#### 职责分离
- [ ] 应用层不包含业务逻辑
  - 业务逻辑在领域层
  - 应用层只负责编排

#### 参数校验
- [ ] 参数校验分层清晰
  - 应用层：参数校验（格式、必填、范围）
  - 领域层：业务规则校验（业务不变量）

---

### 5. 事务管理

#### 事务边界
- [ ] 应用层管理事务边界
  - 使用 @Transactional 注解
  - 事务不泄漏到领域层

#### 事务粒度
- [ ] 一个事务只修改一个聚合
  - 验证：检查事务代码
  - 多个聚合修改应该分多个事务

---

### 6. Command 和 DTO 设计

#### Command 设计
- [ ] Command 表示用户意图
  - 包含输入参数
  - 不包含业务规则
  - 示例：CreateMembershipCommand

#### DTO 设计
- [ ] DTO 是数据传输对象
  - 只包含数据
  - 不包含业务逻辑
  - 不包含业务方法
  - 示例：MembershipDTO

---

### 7. 错误处理

#### 错误分类
- [ ] 错误分类处理正确
  - 参数错误：HTTP 200，业务状态码 400
  - 权限错误：HTTP 200，业务状态码 403
  - 业务错误：HTTP 200，业务状态码 422
  - 系统错误：HTTP 200，业务状态码 500

#### 异常转换
- [ ] 领域异常转换为应用层响应
  - BusinessRuleException → 422
  - ValidationException → 400
  - 系统异常向上抛出

---

### 8. 事件处理设计（v2.1 新增）

#### 事件监听器识别
- [ ] 所有领域事件都有对应的监听器
  - 检查：第二章中的事件发布都有监听器
  - 检查：监听器列表完整

#### 监听器职责
- [ ] 监听器职责清晰
  - 监听器所属应用服务明确
  - 监听器影响的聚合明确
  - 监听器处理逻辑清晰

#### 监听器设计
- [ ] 监听器包含完整的处理步骤
  - 事件接收
  - 幂等性检查
  - 参数校验
  - 调用领域服务/聚合
  - 结果处理

#### 幂等性保证
- [ ] 监听器有幂等性保证
  - 幂等键定义清晰（eventId）
  - 存储位置明确（Redis/DB）
  - 去重逻辑正确

#### 异常处理
- [ ] 监听器有完善的异常处理
  - 异常类型分类清晰
  - 处理方式明确（重试/死信队列）
  - 是否重试的判断标准清晰

---

## 快速验证

### 关键指标
- [ ] 应用服务数量：每个聚合 3-8 个方法
- [ ] 事务粒度：一个事务一个聚合
- [ ] 业务逻辑：应用层无业务逻辑
- [ ] 错误处理：所有错误都有明确的错误码
- [ ] 事件处理：所有事件都有对应的监听器

### 设计验证
- [ ] 画出了应用层图
- [ ] 标注了用户行为和系统行为
- [ ] 标注了事务边界
- [ ] 标注了错误处理流程
- [ ] 标注了事件监听器

---

## 常见问题

**Q: 应用层和领域层的区别是什么？**
A: 应用层编排，领域层执行。应用层负责用例编排、事务管理、调用领域层；领域层负责业务逻辑、不变量校验、状态转移。

**Q: 应用层可以包含业务逻辑吗？**
A: 不可以。应用层只负责编排，业务逻辑必须在领域层。

**Q: 如何区分用户行为和系统行为？**
A: 用户行为由用户操作触发，需要权限控制；系统行为由系统事件触发，无需权限控制。

**Q: 为什么一个事务只能修改一个聚合？**
A: 聚合是强一致性边界，聚合间应该通过领域事件实现最终一致性。

**Q: Command 和 DTO 的区别是什么？**
A: Command 表示用户意图，包含输入参数；DTO 是数据传输对象，包含返回数据。两者都不包含业务逻辑。

---

## 原则追溯

本检查清单基于以下原则：
- `application.md` 1.1-1.2：应用层职责原则
- `application.md` 2.1-2.3：用户行为 vs 系统行为原则
- `application.md` 3.1-3.3：应用服务设计原则
- `application.md` 4.1-4.2：应用层不包含业务逻辑原则
- `application.md` 5.1-5.2：事务管理原则
- `application.md` 6.1-6.2：Command 和 DTO 原则
- `application.md` 7.1-7.2：错误处理原则
- `application.md` Step 4.5：事件处理设计原则（v2.1 新增）
