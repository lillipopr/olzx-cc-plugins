# 第六章检查清单：入口层设计

## 使用说明
- **何时使用**：完成第六章（入口层）设计后
- **预计耗时**：5-10 分钟
- **通过标准**：所有核心项检查通过

---

## 核心检查项

### 1. 入口层核心原则

#### 薄入口层
- [ ] 入口层仅负责参数校验、调用应用层、返回结果
  - 不包含业务逻辑
  - 业务逻辑在应用层和领域层

#### 统一响应格式
- [ ] 所有接口返回统一的响应结构
  ```typescript
  interface ApiResponse<T> {
    code: number          // 业务状态码
    message: string       // 响应消息
    data?: T             // 业务数据
  }
  ```

#### 异常处理
- [ ] 统一的异常处理和错误码映射
  - 参数校验失败：业务状态码 400
  - 权限不足：业务状态码 403
  - 业务规则违反：业务状态码 422
  - 系统错误：业务状态码 500

---

### 2. Controller 层设计

#### 只允许 POST
- [ ] Controller 只允许 POST 接口
  - 不使用 GET、PUT、DELETE
  - 原因：POST 语义清晰，统一风格

#### 接口路径设计
- [ ] 路径设计符合规范
  - 格式：/api/版本/端/聚合名/动作
  - 全小写：wallet、freeze、login
  - 连字符分隔：daily-grant、expire-check
  - 动词结尾：create、cancel、freeze、login

#### 端标识
- [ ] 端标识使用正确
  - m（Mobile）：移动端（iOS/Android App）
  - c（Client）：客户端（通用）
  - w（Web）：网页端（浏览器）
  - a（Admin）：管理端（后台）

#### 路径示例验证
  ```
  ✅ 好的路径设计
  POST /api/v1/m/wallet/freeze        // 移动端：冻结钱包
  POST /api/v1/c/user/login           // 客户端：用户登录
  POST /api/v1/m/membership/create    // 移动端：创建会员
  POST /api/v1/a/order/cancel         // 管理端：取消订单
  ```

---

### 3. 请求参数设计

#### 参数命名
- [ ] 参数命名符合规范
  - 格式：{动作} + {聚合名} + Param
  - 示例：CreateMembershipParam、FreezeWalletParam、CancelOrderParam

#### 禁止原始类型
- [ ] 不使用原始数据类型
  - 不直接使用 string、number、boolean
  - 所有参数必须是对象类型

#### Request Body
- [ ] 使用 Request Body 传递参数
  - 不使用 URL 参数
  - 不使用多个原始类型参数

#### 参数对象设计
- [ ] 参数对象只包含输入字段
  - 不包含业务规则
  - 不包含派生字段

---

### 4. Controller 命名

#### 命名规范
- [ ] Controller 命名符合规范
  - 格式：聚合名 + Controller
  - 示例：MembershipController、CouponController、PaymentController

---

### 5. MQ 层设计

#### 消费者设计
- [ ] 消费者只负责接收消息、调用应用层、确认消息
  - 不包含业务逻辑
  - 业务逻辑在应用层

#### 幂等性
- [ ] 消费者保证幂等性
  - 使用 eventId 作为幂等键
  - 处理前检查是否已处理

#### 异常处理
- [ ] 消费者异常处理正确
  - 参数错误：发送到死信队列，告警，不重试
  - 业务错误：发送到死信队列，告警，不重试
  - 系统错误：重新入队（最多 N 次），重试
  - 超过重试次数：发送到死信队列，告警，不重试

---

### 6. Task 层设计

#### 定时任务设计
- [ ] 定时任务只负责触发、调用应用层、记录日志
  - 不包含业务逻辑
  - 业务逻辑在应用层

#### 分布式锁
- [ ] 定时任务使用分布式锁
  - 获取锁：执行任务
  - 获取失败：跳过本次执行
  - 锁超时：设置合理的超时时间

#### 任务监控
- [ ] 定时任务有监控指标
  - 执行耗时：> 30 秒告警
  - 失败次数：> 3 次/天告警
  - 跳过次数：> 10 次/天告警

---

### 7. 数据模型转换

#### DTO 使用
- [ ] 入口层使用 DTO，不直接使用领域模型
  - Request → Command
  - Domain → DTO
  - 不直接暴露领域模型

#### 参数校验分层
- [ ] 参数校验分层清晰
  - 入口层：格式校验（邮箱格式、手机号格式）
  - 入口层：参数校验（必填字段、数值范围）
  - 领域层：业务规则校验（会员只能有一个生效订阅）

---

### 8. 接口文档

#### 文档完整性
- [ ] 每个接口有完整的文档
  - 接口名称：清晰的接口名称
  - 接口描述：接口的业务含义
  - 请求定义：Request Header、Request Body
  - 响应定义：成功响应、失败响应
  - 请求示例：JSON 示例
  - 响应示例：JSON 示例
  - 错误码：所有可能的错误码

#### 版本控制
- [ ] 接口使用路径版本控制
  - 格式：/api/v1/、/api/v2/
  - 不使用查询参数版本控制

---

## 快速验证

### 关键指标
- [ ] 接口数量：每个聚合 3-8 个接口
- [ ] 接口方法：100% POST 接口
- [ ] 参数类型：100% 使用 Param 对象
- [ ] 响应格式：100% 统一响应格式

### 设计验证
- [ ] 画出了接口图
- [ ] 标注了接口路径
- [ ] 标注了请求参数
- [ ] 标注了响应格式

---

## 常见问题

**Q: 为什么只允许 POST 接口？**
A: POST 语义清晰（表示执行操作），统一风格（所有接口都是 POST），避免歧义（GET、PUT、DELETE 语义容易混淆）。

**Q: 为什么不使用原始数据类型？**
A: 原始数据类型不利于扩展和维护。使用 Param 对象可以方便地添加新字段，保持接口向后兼容。

**Q: 接口路径格式是什么？**
A: 格式是 /api/版本/端/聚合名/动作，例如 /api/v1/m/membership/create。

**Q: 如何保证消费者的幂等性？**
A: 使用 eventId 作为幂等键，处理前检查是否已处理，处理后保存幂等键。

**Q: 定时任务为什么需要分布式锁？**
A: 防止多个实例同时执行同一个定时任务，导致重复执行。

---

## 原则追溯

本检查清单基于以下原则：
- `starter.md` 1.1-1.3：入口层核心原则
- `starter.md` 2.1-2.4：Controller 层原则
- `starter.md` 2.3：请求参数设计原则
- `starter.md` 3.1-3.3：MQ 层原则
- `starter.md` 4.1-4.3：Task 层原则
- `starter.md` 5.1-5.2：入口层与领域层分离原则
- `starter.md` 6.1-6.2：接口文档原则
