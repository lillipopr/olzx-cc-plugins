# 第五章检查清单：领域事件设计

## 使用说明
- **何时使用**：完成第五章（领域事件）设计后
- **预计耗时**：5-10 分钟
- **通过标准**：所有核心项检查通过

---

## 核心检查项

### 1. 领域事件特征

#### 核心特征
- [ ] 领域事件满足所有核心特征
  - 已经发生：表示过去的事实
  - 不可变：一旦发生不能改变
  - 业务相关：表达业务含义
  - 携带数据：包含必要业务数据
  - 有唯一标识：每个事件有唯一 ID

#### 与命令区分
- [ ] 领域事件与命令正确区分
  - 事件：过去时（已做）、聚合发布、唯一确定、必须成功
  - 命令：将来时（要做）、用户/系统发起、可能多个、可以失败

---

### 2. 领域事件识别

#### 识别时机
- [ ] 在正确的时机使用领域事件
  - 状态变化：聚合状态发生重要变化
  - 跨边界协作：需要通知其他上下文
  - 异步处理：触发后台任务
  - 审计追踪：记录关键操作

#### 识别问题
- [ ] 通过问题清单验证事件必要性
  - 这个事情重要到需要通知其他部分吗？
  - 这个事情是一个已经发生的事实吗？
  - 其他上下文需要对这个事情做出反应吗？
  - 需要审计追踪这个事情吗？

---

### 3. 领域事件命名

#### 命名格式
- [ ] 事件命名符合规范
  - 格式：聚合根 + 过去式动词 + Event
  - 示例：MembershipActivatedEvent、OrderPaidEvent、CouponExpiredEvent

#### 命名验证
- [ ] 事件命名不是命令
  - 不是 ActivateMembershipEvent（命令）
  - 而是 MembershipActivatedEvent（事件）

---

### 4. 领域事件设计

#### 事件结构
- [ ] 事件包含必要的业务数据
  - eventId：事件唯一标识
  - 聚合根 ID：关联的聚合根
  - 业务数据：必要的信息
  - 时间戳：事件发生时间

#### 数据最少原则
- [ ] 事件只携带订阅方需要的数据
  - 不携带整个聚合
  - 只包含必要字段

#### 不可变性
- [ ] 事件是不可变的
  - 使用 readonly 修饰属性
  - 事件一旦发布不能修改

---

### 5. 领域事件发布

#### 发布位置
- [ ] 在聚合根方法中发布事件
  - 状态变更完成后发布
  - 不在状态变更前发布

#### 发布时机
- [ ] 发布时机正确
  - 先修改状态
  - 然后发布事件
  - 避免状态修改失败但事件已发布

---

### 6. 领域事件订阅

#### 订阅方处理
- [ ] 订阅方异步处理事件
  - 使用 @EventListener 注解
  - 方法返回 Promise<void>

#### 幂等性
- [ ] 订阅方保证幂等性
  - 使用 eventId 作为幂等键
  - 处理前检查是否已处理

#### 异常处理
- [ ] 订阅方异常不影响发布方
  - try-catch 捕获异常
  - 记录日志但不向上抛出

---

### 7. 常见事件类型

#### 状态变化事件
- [ ] 状态变化事件已识别
  - 创建：聚合根被创建
  - 状态转移：聚合根状态变化
  - 删除：聚合根被删除

#### 业务事件
- [ ] 业务事件已识别
  - 业务操作：业务操作完成
  - 规则触发：业务规则被触发
  - 时间触发：时间点到达

---

## 快速验证

### 关键指标
- [ ] 事件数量：每个聚合 2-5 个事件
- [ ] 订阅方数量：每个事件 1-3 个订阅方
- [ ] 幂等性：所有订阅方都保证幂等性
- [ ] 异步处理：所有订阅方都是异步的

### 设计验证
- [ ] 画出了事件图
- [ ] 标注了事件发布方
- [ ] 标注了事件订阅方
- [ ] 标注了事件数据流

---

## 常见问题

**Q: 领域事件和命令的区别是什么？**
A: 事件是过去时（已做），命令是将来时（要做）。事件由聚合发布，命令由用户/系统发起。事件必须成功，命令可以失败。

**Q: 什么时候需要使用领域事件？**
A: 当需要跨边界协作、异步处理、审计追踪时使用领域事件。

**Q: 如何保证事件订阅的幂等性？**
A: 使用 eventId 作为幂等键，处理前检查是否已处理，处理后保存幂等键。

**Q: 订阅方异常会影响发布方吗？**
A: 不应该。订阅方应该捕获异常并记录日志，不影响事件发布方。

**Q: 事件应该携带多少数据？**
A: 只携带订阅方需要的数据，不携带整个聚合。遵循数据最少原则。

---

## 原则追溯

本检查清单基于以下原则：
- `domain-event.md` 1.1-1.2：领域事件特征原则
- `domain-event.md` 2.1-2.2：领域事件识别原则
- `domain-event.md` 3.1-3.2：领域事件命名原则
- `domain-event.md` 4.1-4.3：领域事件设计原则
- `domain-event.md` 5.1-5.2：领域事件发布原则
- `domain-event.md` 6.1-6.3：领域事件订阅原则
- `domain-event.md` 7.1-7.2：常见领域事件类型
